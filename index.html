<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>bagpipe Documentation</title>
    <meta name="keywords" content="limiter,concurrency limit,parallel limit" />
    <meta name="description" content="bagpipe.js" />
    <script src="assets/prettify.js"></script>
    <script src="assets/jquery-1.8.2.min.js"></script>
    <script src="bootstrap/js/bootstrap.js"></script>
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap-responsive.min.css" />
    <link rel="stylesheet" type="text/css" href="assets/base.css" />
  </head>
  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="./index.html">bagpipe</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
            
              <li>
                <a href="./api.html">API Docs</a>
              </li>
            
            
            </ul>
          </div>
        </div>
      </div>
    </div>
    <header class="jumbotron subhead">
      <div class="container">
        <h1>bagpipe <small>Version: 0.2.0 By @Jackson Tian</small></h1>
        <p class="lead">
          bagpipe.js
        </p>
      </div>
    </header>
<div class="container content">
  <div class="row">
  	<div class="span3 bs-docs-sidebar">
      <ul class="nav nav-list bs-docs-sidenav affix">

  <li class="level_2">
    <a href="#index_起源" title="起源">
      <i class="icon-chevron-right"></i>起源
    </a>
  </li>

  <li class="level_2">
    <a href="#index_安装" title="安装">
      <i class="icon-chevron-right"></i>安装
    </a>
  </li>

  <li class="level_2">
    <a href="#index_API" title="API">
      <i class="icon-chevron-right"></i>API
    </a>
  </li>

  <li class="level_2">
    <a href="#index_原理" title="原理">
      <i class="icon-chevron-right"></i>原理
    </a>
  </li>

  <li class="level_2">
    <a href="#index_模块状态" title="模块状态">
      <i class="icon-chevron-right"></i>模块状态
    </a>
  </li>

  <li class="level_2">
    <a href="#index_最佳实践" title="最佳实践">
      <i class="icon-chevron-right"></i>最佳实践
    </a>
  </li>

  <li class="level_2">
    <a href="#index_实际案例" title="实际案例">
      <i class="icon-chevron-right"></i>实际案例
    </a>
  </li>

  <li class="level_2">
    <a href="#index_License" title="License">
      <i class="icon-chevron-right"></i>License
    </a>
  </li>

</ul>

    </div>
    <div class="span9">
      <section>
        <h1>Bagpipe(风笛)</h1>
<p>You are the bagpiper.  

</p>
<h2>起源</h2>
<p>在Node中我们可以十分方便利用异步和并行来提升我们的业务速度。但是，如果并发量过大，我们的服务器却可能吃不消，我们需要限制并发量。尽管<code>http</code>模块自身有<a href="http://nodejs.org/docs/latest/api/http.html#http_class_http_agent">http.Agent</a>这样的玩意，用于控制socket的数量，但是通常我们的异步API早就封装好了。改动API的内部agent是不现实的，那么我们自己在逻辑层实现吧。

</p>
<h2>安装</h2>
<pre><code>npm install bagpipe</code></pre>
<h2>API</h2>
<p><code>Bagpipe</code>暴露的API只有构造器和实例方法<code>push</code>。

</p>
<p>在原始状态下，我们执行并发可能是如下这样的，这会形成100个并发异步调用。

</p>
<pre><code>for (var i = 0; i &lt; 100; i++) {
  async(function () {
    // 异步调用
  });
}</code></pre>
<p>如果需要限制并发，你的方案会是怎样？

</p>
<p><code>Bagpipe</code>的方案是如下这样的：

</p>
<pre><code>var Bagpipe = require(&#39;bagpipe&#39;);
// 设定最大并发数为10
var bagpipe = new Bagpipe(10);
for (var i = 0; i &lt; 100; i++) {
  bagpipe.push(async, function () {
    // 异步回调执行
  });
}</code></pre>
<p>是的，调用方式仅仅是将方法、参数、回调分拆一下通过<code>push</code>交给<code>bagpipe</code>即可。

</p>
<p>这个方案与你预想的方案相比，如何？

</p>
<h2>原理</h2>
<p><code>Bagpipe</code>通过<code>push</code>将调用传入内部队列。如果活跃调用小于最大并发数，将会被取出直接执行，反之则继续呆在队列中。当一个异步调用结束的时候，会从队列前取出调用执行。以此来保证异步调用的活跃量不高于限定值。<br>当队列的长度大于100或者大于最大并发数的2倍时，Bagpipe对象将会触发它的<code>full</code>事件，该事件传递队列长度值。该值有助于评估业务性能参数。示例如下：

</p>
<pre><code>bagpipe.on(&#39;full&#39;, function (length) {
  console.warn(&#39;底层系统处理不能及时完成，队列拥堵，目前队列长度为:&#39; + length);
});</code></pre>
<h2>模块状态</h2>
<p>单元测试通过状态：<a href="http://travis-ci.org/JacksonTian/bagpipe"><img src="https://secure.travis-ci.org/JacksonTian/bagpipe.png" alt="Build Status"></a>。单元测试覆盖率<a href="http://html5ify.com/bagpipe/coverage.html">100%</a>。

</p>
<h2>最佳实践</h2>
<ul>
<li>确保异步调用的最后一个参数为回调参数</li>
<li>监听<code>full</code>事件，以增加你对业务性能的评估</li>
<li>目前异步方法未支持上下文。确保异步方法内部没有<code>this</code>引用</li>
</ul>
<h2>实际案例</h2>
<p>当你需要遍历文件目录的时候，异步可以确保充分利用IO。你可以轻松发起成千上万个文件的读取。但是，系统文件描述符是有限的。不服的话，遇见下面这个错误再来重读此文。

</p>
<pre><code>Error: EMFILE, too many open files</code></pre>
<p>也有人会考虑用同步方法来进行处理。但是，同步时，CPU与IO并不能并行利用，一定情况下，性能是不可弃的一项指标。用上<code>Bagpipe</code>，可以轻松享受并发，也能限制并发。

</p>
<pre><code>var bagpipe = new Bagpipe(10);

var files = [&#39;这里有很多很多文件&#39;];
for (var i = 0; i &lt; files.length; i++) {
  bagpipe.push(fs.readFile, files[i], &#39;utf-8&#39;, function (err, data) {
    // 不会因为文件描述符过多出错
    // 妥妥的
  });
}</code></pre>
<h2>License</h2>
<p>在<a href="https://github.com/JacksonTian/bagpipe/blob/master/MIT-License">MIT</a>许可证下发布，欢迎享受开源

</p>

      </section>
    </div>
  </div>
</div>
      <footer class="footer">
        <div class="container">
          <p class="pull-right">
            <a href="#">Back to top</a>
          </p>
          <p>此文档通过doxmate生成。主题借鉴Bootstrap API文档风格，注解基于<a href="https://github.com/visionmedia/dox">Dox</a>。欢迎关注doxmate作者<a href="http://weibo.com/shyvo" target="_blank">@朴灵</a></p>
          <ul class="footer-links">
            <li><a href="https://github.com/visionmedia/dox">Dox主页</a></li>
            <li><a href="http://html5ify.com/doxmate">Doxmate主页</a></li>
            <li><a href="https://github.com/JacksonTian/doxmate/issues?state=open">提交bug</a></li>
          </ul>
      </div>
    </footer>
    <script>
      $(function() {
        $('pre').addClass('prettyprint');
        $('td pre').removeClass('prettyprint');
        prettyPrint();
        var $window = $(window);
        $('.bs-docs-sidenav').affix({
          offset: {
            top: function () {
              return $window.width() <= 980 ? 290 : 210
            },
            bottom: 270
          }
        });
        $(".content").find('h1, h2, h3, h4, h5, h6').each(function () {
          var node = $(this);
          if (!node.attr("id")) {
            node.attr("id", "index_" + node.text());
          }
          node.css("paddingTop", 40);
        });
      });
    </script>
  
  </body>
</html>